name: CI/CD
on:
  push:
    branches: [ '*', '!main' ]
  pull_request:
    types: [ opened, synchronize ]
  workflow_dispatch:
    inputs:
      ccb_env:
        description: 'Environment name to deploy the CCB infra'
        required: true
        type: string
  pull_request_review:
    types: [ submitted ]

permissions:
  id-token: write
  contents: write
  pull-requests: write
  actions: write

jobs:
  discover-environment:
    name: "Discover Environment"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions:checkout@v3

      - name: Determine target environments
        id: env
        working-directory: .
        run: |
          target_env="${{ github.event.inputs.ccb_env }}"
          if [-z "$target_env"]
          then
            target_env="ccb-$(date +'%Y%m%d%H%M%S')"
          fi
          echo "matrix=${target_env}" >> $GITHUB_OUTPUT
          echo "${target_env}"